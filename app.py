import streamlit as st
from st_supabase_connection import SupabaseConnection

# ---------------------------------------------------------
# 1. ãƒšãƒ¼ã‚¸åŸºæœ¬è¨­å®š (ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ä¸­å¤®å¯„ã›)
# ---------------------------------------------------------
st.set_page_config(
    page_title="ã‹ã‚Šã‚“ã¨ã‚°ãƒ«ãƒ¼ãƒ— | ã‚­ãƒ£ã‚¹ãƒˆãƒãƒ¼ã‚¿ãƒ«",
    page_icon="ğŸ’–",
    layout="centered"
)

# ---------------------------------------------------------
# 2. Supabase æ¥ç¶šè¨­å®š
# ---------------------------------------------------------
# secrets.toml ã¾ãŸã¯ Streamlit Cloud ã® Secrets ã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿
conn = st.connection("supabase", type=SupabaseConnection)

# ---------------------------------------------------------
# 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šç°¡æ˜“ãƒ­ã‚°ã‚¤ãƒ³
# ---------------------------------------------------------
st.sidebar.title("ğŸ‘¤ ã‚­ãƒ£ã‚¹ãƒˆèªè¨¼")
cast_name = st.sidebar.text_input("åå‰ã¾ãŸã¯IDã‚’å…¥åŠ›", value="TEST_001")
st.sidebar.info("â€»ãƒ†ã‚¹ãƒˆé‹ç”¨ä¸­ã®ãŸã‚ã€IDå…¥åŠ›ã§ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚")

# ---------------------------------------------------------
# 4. ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šãƒ˜ãƒƒãƒ€ãƒ¼
# ---------------------------------------------------------
st.title("ğŸ’– ã‚­ãƒ£ã‚¹ãƒˆå®Ÿç¸¾å…¥åŠ›")
st.write(f"ãŠç–²ã‚Œæ§˜ã§ã™ã€**{cast_name}** ã•ã‚“ï¼ä»Šæ—¥ã®é ‘å¼µã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†âœ¨")

# ---------------------------------------------------------
# 5. å®Ÿç¸¾å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# ---------------------------------------------------------
with st.form("earnings_form", clear_on_submit=True):
    st.subheader("ğŸ’° æœ¬æ—¥ã®å®Ÿç¸¾")
    
    # ç¨¼åƒæ—¥
    work_date = st.date_input("ç¨¼åƒæ—¥")
    
    # æ‰‹å–ã‚Šé¡ï¼ˆLaTeXã§è¨ˆç®—å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
    st.write("æ‰‹å–ã‚Šåˆè¨ˆé¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    amount = st.number_input("æœ¬æ—¥ã®çµ¦ä¸ (å††)", min_value=0, step=1000, help="æºæ³‰ã‚„é›‘è²»ã‚’å¼•ã„ãŸå¾Œã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    
    # ãƒ¡ãƒ¢
    memo = st.text_area("å†…å®¹ãƒ¡ãƒ¢", placeholder="ä¾‹ï¼š60åˆ†Ã—3æœ¬ã€æœ¬æŒ‡åã‚ã‚Šã€ã‚ªãƒ ãƒ©ã‚¤ã‚¹é£Ÿã¹ãŸï¼")
    
    # ä¿å­˜ãƒœã‚¿ãƒ³
    submit_button = st.form_submit_button("ã“ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹ âœ¨")

# ---------------------------------------------------------
# 6. ä¿å­˜å‡¦ç†
# ---------------------------------------------------------
if submit_button:
    if amount == 0:
        st.warning("é‡‘é¡ãŒ0å††ã§ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿå…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã­ã€‚")
    
    try:
        # Supabaseã® daily_earnings ãƒ†ãƒ¼ãƒ–ãƒ«ã¸æŒ¿å…¥
        insert_data = {
            "cast_id": cast_name,
            "date": work_date.isoformat(),
            "amount": amount,
            "memo": memo
        }
        conn.table("daily_earnings").insert(insert_data).execute()
        
        # æˆåŠŸæ¼”å‡º
        st.success(f"ä¿å­˜ã—ã¾ã—ãŸï¼ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸ ğŸŒˆ\nã€{work_date}ï¼šÂ¥{amount:,}ã€‘")
        st.balloons()
        
    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚åº—é•·ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼å†…å®¹: {e}")

st.divider()

# ---------------------------------------------------------
# 7. å±¥æ­´ã®ç¢ºèªï¼ˆç›´è¿‘5ä»¶ï¼‰
# ---------------------------------------------------------
st.subheader("ğŸ“… æœ€è¿‘ã®å…¥åŠ›å±¥æ­´")
try:
    history = conn.table("daily_earnings") \
        .select("date, amount, memo") \
        .eq("cast_id", cast_name) \
        .order("date", desc=True) \
        .limit(5) \
        .execute()

    if history.data:
        for item in history.data:
            with st.expander(f"ğŸ“… {item['date']} | Â¥{item['amount']:,}"):
                st.write(f"ğŸ“ ãƒ¡ãƒ¢: {item['memo'] or 'ãªã—'}")
    else:
        st.write("ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®å…¥åŠ›ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼")

except Exception:
    st.write("å±¥æ­´ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚")
